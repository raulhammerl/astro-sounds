---
import EmojiReactions from './EmojiReactions.astro';
import Comments from './Comments.astro';

const { post } = Astro.props;

// 1. Data mapping from Supabase object
const { artist, title, youtube_url, description, posted_by, created_at, slug } = post;

// 2. Helper to get the 11-character YouTube ID from a full URL
const getYoutubeId = (url) => {
  if (!url) return null;
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
};

const youtubeId = getYoutubeId(youtube_url);
const thumbnailUrl = `https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg`;

// 3. Format the Supabase timestamp
const formattedDate = created_at 
  ? new Date(created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
  : 'RECENT';
---

<article class="cell">
  <div class="post-meta">
    {formattedDate} &nbsp; {posted_by}
  </div>
  
  <div class="post-title-container">
     <span class="artist">{artist}</span>
     <span class="divider"> // </span>
     <span class="track-title">{title}</span>
  </div>

  {youtubeId && (
    <div class="video-placeholder" data-id={youtubeId} data-title={`${artist} - ${title}`}>
      <img src={thumbnailUrl} alt={title} loading="lazy" />
      <div class="play-button">â–¶</div>
    </div>
  )}

  {description && <p class="post-description">{description}</p>}

  <EmojiReactions slug={slug} />
  <Comments slug={slug} />

</article>

<script>
  function initVideoPlaceholders() {
    const placeholders = document.querySelectorAll('.video-placeholder');

    placeholders.forEach(wrapper => {
      if (wrapper.querySelector('iframe')) return;

      wrapper.addEventListener('click', () => {
        const id = wrapper.getAttribute('data-id');
        const title = wrapper.getAttribute('data-title');
        
        const iframe = document.createElement('iframe');
        iframe.setAttribute('src', `https://www.youtube.com/embed/${id}?autoplay=1`);
        iframe.setAttribute('title', title || 'Video');
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        iframe.setAttribute('allowfullscreen', 'true');
        
        wrapper.innerHTML = '';
        wrapper.appendChild(iframe);
      });
    });
  }

  initVideoPlaceholders();
  document.addEventListener('astro:after-swap', initVideoPlaceholders);
</script>

<style>
  .cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    margin-bottom: 5rem; 
    padding-bottom: 2rem;
    width: 100%;
  }

  .post-meta {
    font-size: 0.8rem;
    margin-bottom: 1rem;
    background: var(--meta-bg);
    color: var(--meta-text);
    padding: 2px 8px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .post-title-container {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text);
    text-transform: uppercase;
    margin-bottom: 1.5rem;
    line-height: 1.2;
    font-family: var(--font-mono);
  }

  /* Artist is prominent, Track Title uses the muted variable for contrast */
  .artist { color: var(--text); }
  .divider { color: var(--separator-color); font-weight: 400; }
  .track-title { color: var(--text-muted); }

  .post-description {
    margin-top: 1.5rem;
    font-size: 0.95rem;
    line-height: 1.6;
    max-width: 650px;
    color: var(--text); /* description now adapts to theme */
  }

  .video-placeholder {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000; /* Keep background black for video feel */
    cursor: pointer;
    position: relative;
    border: 1px solid var(--text); /* Border follows theme text color */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .video-placeholder img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7; /* Slightly dimmer to fit the dark theme better */
    transition: opacity 0.2s ease;
  }

  .video-placeholder:hover img {
    opacity: 1;
  }

  /* Play button uses accent variables for high-contrast inverting */
  .play-button {
    position: absolute;
    width: 60px;
    height: 40px;
    background: var(--accent-inv);
    color: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    border: 2px solid var(--accent);
    z-index: 2;
    pointer-events: none;
    transition: all 0.2s ease;
  }

  .video-placeholder:hover .play-button {
    background: var(--accent);
    color: var(--accent-inv);
    border-color: var(--accent-inv);
  }

  .video-placeholder :global(iframe) {
    width: 100%;
    height: 100%;
  }
</style>
