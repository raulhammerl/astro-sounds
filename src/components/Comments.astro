---
import { supabase } from "../lib/supabase";

const { slug } = Astro.props;

// --- 1. Server-Side Fetch ---
let { data: comments, error } = await supabase
  .from("comments")
  .select("username, content, created_at")
  .eq("slug", slug)
  .order("created_at", { ascending: true });

if (error) {
  console.error("Error fetching comments:", error);
  comments = [];
}

const formatTimestamp = (dateString) => {
  const date = new Date(dateString);
  return date.toLocaleTimeString("en-GB", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  });
};
---

<div class="comments-section" data-slug={slug}>
  <div class="separator">
    -- COMMENTS -----------------------------------------------------
  </div>

  <div class="comment-feed">
    {
      comments && comments.length > 0 ? (
        comments.map((comment) => (
          <div class="comment-entry">
            <div class="comment-meta">
              {comment.username} - {formatTimestamp(comment.created_at)}
            </div>
            <p class="comment-body">{comment.content}</p>
          </div>
        ))
      ) : (
        <div class="no-comments">NO_DATA_FOUND_</div>
      )
    }
  </div>

  <div class="form-toggle-wrapper">
    <button class="cmd-btn toggle-comment-btn">[ADD_COMMENT]</button>
  </div>

  <div class="comment-form-container hidden">
    <div class="input-header">WRITE_COMMENT_</div>
    <textarea class="comment-area" placeholder="TYPE_MESSAGE_HERE..." rows="3"
    ></textarea>
    <div class="form-footer">
      <input
        type="text"
        class="comment-user-input name-input"
        placeholder="NAME"
      />
      <button type="button" class="submit-comment-btn">[SEND]</button>
    </div>
  </div>
</div>

<template id="comment-template">
  <div class="comment-entry">
    <div class="comment-meta"></div>
    <p class="comment-body"></p>
  </div>
</template>

<style>
  .comments-section {
    margin-top: 1.5rem;
    width: 100%;
    text-align: left;
    font-family: var(--font-mono);
  }
  .comment-feed {
    margin: 1.5rem 0;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .comment-entry {
    border-left: 1px solid var(--separator-color);
    padding-left: 1rem;
  }
  .comment-meta {
    font-size: 0.65rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 0.2rem;
  }
  .comment-body {
    font-size: 0.85rem;
    color: var(--text);
    margin: 0;
    line-height: 1.4;
  }
  .no-comments {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Toggle Button */
  .cmd-btn {
    background: transparent;
    border: none;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    color: var(--text-muted);
    padding: 0;
  }
  .cmd-btn:hover {
    color: var(--text);
    text-decoration: underline;
  }

  /* Form Container: Now uses var(--bg) to stay dark in dark mode */
  .comment-form-container {
    margin-top: 1.5rem;
    border: 1px solid var(--separator-color);
    padding: 1rem;
    background: var(--bg); /* Fixed the white block issue */
  }
  .comment-form-container.hidden {
    display: none !important;
  }
  .input-header {
    font-size: 0.7rem;
    font-weight: 800;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  textarea {
    width: 100%;
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--separator-color);
    font-family: var(--font-mono);
    padding: 0.5rem;
    font-size: 0.85rem;
    outline: none;
    resize: vertical;
  }

  .form-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    gap: 1rem;
    align-items: center;
  }

  .name-input {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--separator-color);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    flex-grow: 1;
    outline: none;
    padding-bottom: 2px;
  }

  /* Submit Button: Matches Nav styling */
  .submit-comment-btn {
    background: transparent;
    border: 1px solid var(--separator-color);
    font-family: var(--font-mono);
    font-weight: 800;
    cursor: pointer;
    color: var(--text);
    padding: 0.2rem 0.5rem;
    transition: all 0.2s ease;
  }

  .submit-comment-btn:hover {
    background: var(--accent);
    color: var(--accent-inv);
    border-color: var(--accent);
  }
</style>

<script>
  import { supabase } from "../lib/supabase";
  import { getUser, saveUser } from "../lib/identity";

  function initComments() {
    const sections = document.querySelectorAll(".comments-section");
    const template = document.getElementById(
      "comment-template",
    ) as HTMLTemplateElement;

    sections.forEach((section) => {
      const slug = section.getAttribute("data-slug");
      const toggleBtn = section.querySelector(".toggle-comment-btn");
      const formContainer = section.querySelector(".comment-form-container");
      const submitBtn = section.querySelector(
        ".submit-comment-btn",
      ) as HTMLButtonElement;
      const nameInput = section.querySelector(
        ".comment-user-input",
      ) as HTMLInputElement;
      const textArea = section.querySelector(
        ".comment-area",
      ) as HTMLTextAreaElement;
      const feed = section.querySelector(".comment-feed");

      const existingUser = getUser();
      if (existingUser && nameInput) nameInput.value = existingUser;

      toggleBtn?.addEventListener("click", () => {
        const isHidden = formContainer.classList.contains("hidden");
        if (isHidden) {
          formContainer.classList.remove("hidden");
          toggleBtn.textContent = "[CANCEL_]";
        } else {
          formContainer.classList.add("hidden");
          toggleBtn.textContent = "[ADD_COMMENT]";
        }
      });

      submitBtn?.addEventListener("click", async () => {
        const username = nameInput.value.trim().toUpperCase();
        const content = textArea.value.trim();

        if (!username || !content) {
          alert("ERROR: BOTH_FIELDS_REQUIRED");
          return;
        }

        saveUser(username);
        submitBtn.textContent = "[SENDING...]";
        submitBtn.disabled = true;

        const { data, error } = await supabase
          .from("comments")
          .insert([{ slug, username, content }])
          .select()
          .single();

        if (error) {
          console.error("Supabase Error:", error);
          alert("SYSTEM_ERROR: COULD_NOT_POST");
          submitBtn.textContent = "[SEND]";
          submitBtn.disabled = false;
        } else {
          const emptyState = feed.querySelector(".no-comments");
          if (emptyState) emptyState.remove();

          if (template) {
            const clone = template.content.cloneNode(true) as DocumentFragment;
            const time = new Date(data.created_at).toLocaleTimeString("en-GB", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });

            clone.querySelector(".comment-meta").textContent =
              `${username} - ${time}`;
            clone.querySelector(".comment-body").textContent = content;

            feed.appendChild(clone);
          }

          textArea.value = "";
          submitBtn.textContent = "[SEND]";
          submitBtn.disabled = false;
          formContainer.classList.add("hidden");
          toggleBtn.textContent = "[ADD_COMMENT]";
        }
      });
    });
  }

  initComments();
  document.addEventListener("astro:after-swap", initComments);
</script>
