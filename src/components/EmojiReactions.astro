---
import { supabase } from '../lib/supabase';

const { slug } = Astro.props;
const availableEmojis = ['ðŸ”¥', 'ðŸ”Š', 'ðŸ’¿', 'ðŸ•¹ï¸', 'ðŸ’Ž', 'ðŸŽ¹', 'ðŸ¥°', 'ðŸ˜¬', 'ðŸ˜µâ€ðŸ’«', 'ðŸ¤¯', 'ðŸ¤£', 'ðŸ‘'];

// --- 1. Server-Side Data Fetching ---
// Fetch all raw reactions for this specific post
let { data: rawReactions, error } = await supabase
  .from('reactions')
  .select('emoji, username')
  .eq('slug', slug);

if (error) {
  console.error("Error fetching reactions:", error);
  rawReactions = [];
}

// --- 2. Data Transformation ---
// Group the raw rows by emoji: { "ðŸ”¥": ["JONAS", "RAUL"], "ðŸ’¿": ["SARAH"] }
const groupedReactions = (rawReactions || []).reduce((acc, curr) => {
  if (!acc[curr.emoji]) {
    acc[curr.emoji] = [];
  }
  acc[curr.emoji].push(curr.username);
  return acc;
}, {});

// Convert back to an array for mapping in JSX
const existingReactionEntries = Object.entries(groupedReactions);
---

<div class="reaction-wrapper" data-slug={slug}>
  <div class="active-reactions">
    <span class="prefix">REACTIONS//</span>
    
    <div class="reaction-list">
      {existingReactionEntries.map(([emoji, names]) => (
        <div class="reaction-item" tabindex="0">
          <div class="reaction-badge">
            <span class="emoji">{emoji}</span> 
            <span class="count">{names.length.toString().padStart(2, '0')}</span>
          </div>
          <div class="name-tooltip">
            {names.join(', ')}
          </div>
        </div>
      ))}
    </div>

    <div class="add-reaction-container">
      <button class="add-btn" type="button">[+]</button>
      <div class="emoji-menu">
        <div class="menu-inner">
          {availableEmojis.map(emoji => (
            <button class="menu-item" data-emoji={emoji} type="button">
              {emoji}
            </button>
          ))}
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  /* --- General Layout --- */
  .reaction-wrapper {
    margin: 1rem 0;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    display: flex;
    justify-content: center;
  }

  .active-reactions {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .prefix {
    color: #888;
    font-weight: 800;
    font-size: 0.75rem;
  }

  .reaction-list {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  /* --- Existing Reaction Item & Tooltip --- */
  .reaction-item {
    position: relative;
    cursor: help; /* Indicates tooltip info */
  }

  .reaction-badge {
    border: 1px solid #bcbcbc;
    display: flex;
    gap: 4px;
    padding: 1px 5px;
    font-size: 0.75rem;
    color: #666;
    background: #fff;
    align-items: center;
  }

  .reaction-badge .emoji {
    font-size: 0.9rem;
    filter: grayscale(100%);
    transition: filter 0.2s ease;
  }
  
  /* Hover state for existing badge */
  .reaction-item:hover .reaction-badge {
    border-color: #000;
    color: #000;
  }
  
  .reaction-item:hover .emoji {
    filter: grayscale(0%);
  }

  /* The Tooltip Box */
  .name-tooltip {
    position: absolute;
    bottom: 130%; /* Position above */
    left: 50%;
    transform: translateX(-50%);
    background: #000;
    color: #fff;
    padding: 3px 6px;
    font-size: 0.65rem;
    white-space: nowrap;
    font-weight: 700;
    /* Hidden by default */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.1s ease, visibility 0.1s ease;
    z-index: 20;
    pointer-events: none; /* Prevents tooltip from interfering with mouse */
  }
  
  /* Show Tooltip on Hover (and Focus for accessibility) */
  .reaction-item:hover .name-tooltip,
  .reaction-item:focus .name-tooltip {
    opacity: 1;
    visibility: visible;
  }

  /* --- Add Menu (Reused from previous iteration) --- */
  .add-reaction-container { position: relative; padding: 10px 0; margin: -10px 0; }
  .add-btn { background: transparent; border: none; cursor: pointer; color: #bcbcbc; font-weight: 800; font-family: var(--font-mono); padding: 0 4px;}
  .add-btn:hover { color: #000; }
  .emoji-menu { position: absolute; bottom: 80%; left: 50%; transform: translateX(-50%); z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.1s ease, visibility 0.1s ease; padding-bottom: 15px; }
  .add-reaction-container:hover .emoji-menu { opacity: 1; visibility: visible; }
  .menu-inner { background: #fff; border: 1px solid #000; display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 4px; box-shadow: 3px 3px 0px #bcbcbc; }
  .menu-item { background: transparent; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; transition: background 0.1s; }
  .menu-item:hover { background: #eee; }
</style>

<script>
  import { supabase } from '../lib/supabase';
  import { promptForIdentity } from '../lib/identity';

  function initReactions() {
    const modules = document.querySelectorAll('.reaction-wrapper');

    modules.forEach(module => {
      const slug = module.getAttribute('data-slug');
      const menuItems = module.querySelectorAll('.menu-item');

      menuItems.forEach(item => {
        // Remove old listeners to prevent duplicates on View Transitions
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);

        newItem.addEventListener('click', async (e) => {
          e.stopPropagation();
          
          // 1. Get Identity
          const username = promptForIdentity();
          if (!username) return; // User cancelled prompt

          const emoji = newItem.getAttribute('data-emoji');
          
          // 2. Optimistic UI Update (Optional but makes it feel fast)
          // We could manually add the element here, but reloading is safer for consistency.
          newItem.style.opacity = '0.5'; // Visual feedback that something is happening

          // 3. Send to Supabase
          const { error } = await supabase
            .from('reactions')
            .insert([{ slug, emoji, username }]);

          if (error) {
             // Error 23505 is a unique constraint violation (user already reacted)
             if(error.code !== '23505') {
                console.error('Error adding reaction:', error);
                alert("SYSTEM_ERROR: Could not save reaction.");
             }
             newItem.style.opacity = '1'; // Reset UI on error/duplicate
          } else {
            // 4. Success! Reload to fetch new data from server
            // Using location.replace to avoid adding to history stack
            window.location.replace(window.location.href);
          }
        });
      });
    });
  }

  // Initialize on load
  initReactions();
  
  // Re-init if using Astro View Transitions later
  document.addEventListener('astro:after-swap', initReactions);
</script>
