<button id="theme-toggle" aria-label="Toggle dark mode">
  <span class="text-to-light">LIGHT_MODE</span>
  <span class="text-to-dark">DARK_MODE</span>
</button>

<style>
  #theme-toggle {
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-family: var(--font-mono);
    border: 1px solid var(--search-border, #000);
    background: transparent;
    color: var(--search-text, #000);
    text-transform: uppercase;
    font-size: 0.7rem;
  }

  /* Logic: CSS handles the button text based on the data-theme attribute */
  .text-to-light {
    display: none;
  }
  .text-to-dark {
    display: inline;
  }

  :root[data-theme="dark"] .text-to-dark {
    display: none;
  }
  :root[data-theme="dark"] .text-to-light {
    display: inline;
  }
</style>

<script is:inline>
  function initTheme() {
    const mq = window.matchMedia("(prefers-color-scheme: dark)");
    const html = document.documentElement;

    // 1. Instant System Sync (Your exact function logic)
    const sync = (e) => {
      html.setAttribute("data-theme", e.matches ? "dark" : "light");
      localStorage.setItem("theme", ""); // Reset to sync mode
    };
    mq.addListener(sync);

    // 2. Manual Toggle Logic
    document.getElementById("theme-toggle")?.addEventListener("click", () => {
      const stored = localStorage.getItem("theme");
      const isDark = stored ? stored === "dark" : mq.matches;
      const next = isDark ? "light" : "dark";

      html.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    // 3. Initial Load logic
    const saved = localStorage.getItem("theme");
    html.setAttribute("data-theme", saved || (mq.matches ? "dark" : "light"));
  }

  initTheme();
  document.addEventListener("astro:after-swap", initTheme);
</script>
