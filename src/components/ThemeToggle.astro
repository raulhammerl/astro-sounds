<button id="theme-toggle" aria-label="Toggle dark mode">
  <span class="text-to-light">LIGHT_MODE</span>
  <span class="text-to-dark">DARK_MODE</span>
</button>

<style>
  #theme-toggle {
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-family: var(--font-mono);
    border: 1px solid var(--search-border, #000);
    background: transparent;
    color: var(--search-text, #000);
    text-transform: uppercase;
    font-size: 0.7rem;
  }

  /* Logic: The CSS reacts instantly to the data-theme attribute */
  .text-to-light {
    display: none;
  }
  .text-to-dark {
    display: inline;
  }

  :root[data-theme="dark"] .text-to-dark {
    display: none;
  }
  :root[data-theme="dark"] .text-to-light {
    display: inline;
  }
</style>

<script is:inline>
  // We wrap this in a function so we can re-init on Astro page changes
  function initThemeSwitcher() {
    const systemInitiatedDark = window.matchMedia(
      "(prefers-color-scheme: dark)",
    );
    const toggleBtn = document.getElementById("theme-toggle");

    // 1. YOUR EXACT FUNCTION (Updated for data-theme)
    function prefersColorTest(systemInitiatedDark) {
      if (systemInitiatedDark.matches) {
        document.documentElement.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", ""); // Reset to sync mode
      } else {
        document.documentElement.setAttribute("data-theme", "light");
        localStorage.setItem("theme", ""); // Reset to sync mode
      }
    }

    // YOUR EXACT LISTENER (Using .addListener as per your old version)
    systemInitiatedDark.addListener(prefersColorTest);

    // 2. YOUR EXACT SWITCHER (Updated for data-theme)
    function modeSwitcher() {
      let theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.documentElement.setAttribute("data-theme", "light");
        localStorage.setItem("theme", "light");
      } else if (theme === "light") {
        document.documentElement.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", "dark");
      } else if (systemInitiatedDark.matches) {
        document.documentElement.setAttribute("data-theme", "light");
        localStorage.setItem("theme", "light");
      } else {
        document.documentElement.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", "dark");
      }
    }

    // Attach the switcher to the button
    toggleBtn?.removeEventListener("click", modeSwitcher);
    toggleBtn?.addEventListener("click", modeSwitcher);

    // 3. YOUR EXACT INITIAL LOAD LOGIC
    let theme = localStorage.getItem("theme");
    if (theme === "dark") {
      document.documentElement.setAttribute("data-theme", "dark");
    } else if (theme === "light") {
      document.documentElement.setAttribute("data-theme", "light");
    } else {
      // If no theme, follow system default
      document.documentElement.setAttribute(
        "data-theme",
        systemInitiatedDark.matches ? "dark" : "light",
      );
    }
  }

  // Run on initial load
  initThemeSwitcher();

  // Run after Astro page swaps (essential for blogs with View Transitions)
  document.addEventListener("astro:after-swap", initThemeSwitcher);
</script>
